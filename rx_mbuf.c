/*==================================================================================================

    Module Name:  rx_mbuf.c

    General Description: Implements the rx_mbuf management

====================================================================================================

====================================================================================================
                                           INCLUDE FILES
==================================================================================================*/
#include <stdlib.h>
#include "mem_map.h"
#include "rx_mbuf.h"

/*==================================================================================================
                                          LOCAL CONSTANTS
==================================================================================================*/

/*==================================================================================================
                                           LOCAL MACROS
==================================================================================================*/

/*==================================================================================================
                            LOCAL TYPEDEFS (STRUCTURES, UNIONS, ENUMS)
==================================================================================================*/

/*==================================================================================================
                                     LOCAL FUNCTION PROTOTYPES
==================================================================================================*/

/*==================================================================================================
                                         GLOBAL VARIABLES
==================================================================================================*/

/*==================================================================================================
                                          LOCAL VARIABLES
==================================================================================================*/

/*==================================================================================================
                                         GLOBAL FUNCTIONS
==================================================================================================*/

/*=============================================================================================*//**
@brief init rx mbuf rte_rings
*//*==============================================================================================*/
void  rx_mbuf_init()
{
    int              i;
    struct rte_ring* r      = global_mem->base + RX_MBUF_RING_OFFSET;
    void*            p_mbuf = rx_mbuf_mem->base;

    rte_ring_init(r, RX_MBUF_COUNT);

    for (i = 0; i < RX_MBUF_COUNT; i++, p_mbuf += MBUF_SIZE)
    {
        r->ring[i] = p_mbuf;
    }

    /* till now the ring should be full */
    r->prod.head += RX_MBUF_COUNT - 1;
    r->prod.tail += RX_MBUF_COUNT - 1;

    if (!rte_ring_full(r))
    {
        printf("%s(): the rx mbuf pool ring is not full!\n", __func__);
        exit(1);
    }
}

/*=============================================================================================*//**
@brief get one mbuf

@param[in] pool - pointer to mbuf pool
*//*==============================================================================================*/
void* rx_mbuf_get()
{
    void*            mbuf = NULL;
    struct rte_ring* r    = global_mem->base + RX_MBUF_RING_OFFSET;

    /* this is sc dequeue for the rx thread, not mc */
    if (rte_ring_sc_dequeue(r, &mbuf) != 0)
    {
        printf("%s(): no mbuf available in the mbuf pool!\n", __func__);
        return NULL;
    }

    return mbuf;
}


/*=============================================================================================*//**
@brief free one mbuf

@param[in] mbuf - pointer to one mbuf
*//*==============================================================================================*/
void rx_mbuf_put(void* mbuf)
{
    struct rte_ring* r = global_mem->base + RX_MBUF_RING_OFFSET;

    if (rte_ring_mp_enqueue(r, &mbuf) != 0)
    {
        printf("%s(): can't enqueue mbuf to the mbuf pool!\n", __func__);
    }
}

/*==================================================================================================
                                          LOCAL FUNCTIONS
==================================================================================================*/

